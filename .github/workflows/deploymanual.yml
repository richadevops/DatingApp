name: Release Deployment

on:
  workflow_dispatch:
    inputs:
      build_run_number:
        description: "Enter the build workflow run number to fetch artifacts from"
        required: true
        type: string

      environment:
        description: "Select environment to deploy"
        required: true
        type: choice
        options:
          - sit
          - qa
          - uat

jobs:
  deploy:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download artifact from specified build run
        uses: actions/download-artifact@v4
        with:
          name: app-${{ github.event.inputs.environment }}
          path: ./deploy
          repository: ${{ github.repository }}
          workflow: build.yml             # your build workflow filename
          run-number: ${{ github.event.inputs.build_run_number }}
          workflow_conclusion: success

      - name: Show downloaded files
        run: |
          echo "âœ… Downloaded artifact for ${{ github.event.inputs.environment }}"
          echo "ðŸ“¦ From build run number: ${{ github.event.inputs.build_run_number }}"
          ls -R ./deploy

      - name: Set environment variables
        run: |
          ENV=${{ github.event.inputs.environment }}
          echo "Environment selected: $ENV"

          if [ "$ENV" == "sit" ]; then
            echo "APP_NAME=myapp-sit" >> $GITHUB_ENV
          elif [ "$ENV" == "qa" ]; then
            echo "APP_NAME=myapp-qa" >> $GITHUB_ENV
          elif [ "$ENV" == "uat" ]; then
            echo "APP_NAME=myapp-uat" >> $GITHUB_ENV
          fi

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}
          package: ./deploy
