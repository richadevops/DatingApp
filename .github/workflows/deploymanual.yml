name: Release Deployment

on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: "Enter the build workflow Run ID to fetch artifacts from"
        required: true
        type: string

      environment:
        description: "Select environment to deploy"
        required: true
        type: choice
        options:
          - sit
          - qa
          - uat

permissions:
  id-token: write
  contents: read       # Required to read artifacts
  actions: read        # Required to access workflow run artifacts

jobs:
  deploy:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-${{ github.event.inputs.environment }}
          path: ./deploy
          repository: ${{ github.repository }}
          run-id: ${{ github.event.inputs.build_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set environment variables
        run: |
          ENV=${{ github.event.inputs.environment }}
          echo "Environment selected: $ENV"

          if [ "$ENV" == "sit" ]; then
            echo "APP_NAME=myapp-sit" >> $GITHUB_ENV
          elif [ "$ENV" == "qa" ]; then
            echo "APP_NAME=myapp-qa" >> $GITHUB_ENV
          elif [ "$ENV" == "uat" ]; then
            echo "APP_NAME=myapp-uat" >> $GITHUB_ENV
          fi

      - name: Azure Login (OIDC)
        uses: azure/login@v2.3.0
        with:
         client-id: ${{ secrets.CLIENTID }}
         tenant-id: ${{ secrets.TENANTID }}
         subscription-id: ${{ secrets.SUBSCRIPTIONID }}
         auth-type: SERVICE_PRINCIPAL

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3.0.5
        with:
           app-name: ${{ env.APP_NAME }}   
           package: ./deploy
           publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
