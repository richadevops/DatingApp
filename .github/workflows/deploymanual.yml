name: Release Deployment

on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: "Enter the build workflow Run ID to fetch artifacts from"
        required: true
        type: string

      environment:
        description: "Select environment to deploy"
        required: true
        type: choice
        options:
          - sit
          - qa
          - uat

jobs:
  deploy:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      # ✅ Download artifact from another workflow run (correct syntax)
      - name: Download artifact from build workflow
        uses: actions/download-artifact@v4
        with:
          name: app-${{ github.event.inputs.environment }}
          path: ./deploy
          repository: ${{ github.repository }}
          run-id: ${{ github.event.inputs.build_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show downloaded files
        run: |
          echo "✅ Downloaded artifact for ${{ github.event.inputs.environment }}"
          echo "🏃 From build run ID: ${{ github.event.inputs.build_run_id }}"
          ls -R ./deploy || echo "⚠️ No files found in ./deploy"

      - name: Set environment variables
        run: |
          ENV=${{ github.event.inputs.environment }}
          echo "Environment selected: $ENV"

          if [ "$ENV" == "sit" ]; then
            echo "APP_NAME=myapp-sit" >> $GITHUB_ENV
          elif [ "$ENV" == "qa" ]; then
            echo "APP_NAME=myapp-qa" >> $GITHUB_ENV
          elif [ "$ENV" == "uat" ]; then
            echo "APP_NAME=myapp-uat" >> $GITHUB_ENV
          fi

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_SERVICE_NAME }}
          package: ./deploy
