name: Release Deployment

on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: "Enter the build workflow Run ID to fetch artifacts from"
        required: false
        type: string

      environment:
        description: "Select environment to deploy"
        required: true
        type: choice
        options:
          - sit
          - qa
          - uat

permissions:
  #id-token: write
  contents: read       # Required to read artifacts
  actions: read        # Required to access workflow run artifacts

jobs:
  deploy:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Determine build run ID
        id: get_run_id
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ github.event.inputs.build_run_id }}" ]; then
            echo "Using provided build run ID: ${{ github.event.inputs.build_run_id }}"
            echo "run_id=${{ github.event.inputs.build_run_id }}" >> $GITHUB_OUTPUT
          else
            echo "Fetching latest successful build workflow run..."
            LATEST_RUN_ID=$(gh api \
              -H "Accept: application/vnd.github+json" \
              /repos/${GITHUB_REPOSITORY}/actions/workflows/buildlatest.yml/runs \
              | jq '.workflow_runs[] | select(.conclusion=="success") | .id' | head -n 1)
            echo "Latest run ID is $LATEST_RUN_ID"
            echo "run_id=$LATEST_RUN_ID" >> $GITHUB_OUTPUT
          fi
          
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-${{ github.event.inputs.environment }}
          path: ./deploy
          repository: ${{ github.repository }}
          run-id: ${{ github.event.inputs.build_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      #- name: Azure Login (OIDC)
       # uses: azure/login@v2.3.0
        #with:
         #client-id: ${{ secrets.CLIENTID }}
         #tenant-id: ${{ secrets.TENANTID }}
         #subscription-id: ${{ secrets.SUBSCRIPTIONID }}
         #auth-type: SERVICE_PRINCIPAL

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3.0.5
        with:
           app-name: ${{ secrets.APP_SERVICE_NAME }}   
           publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
           package: ./deploy
          
